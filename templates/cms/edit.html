{% extends "/cms/admin.html" %}

{% block content %}
<div class="container mt-5">
  <div class="card">
    <div class="card-header">
      <h2>Edit Property</h2>
    </div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="title">Title</label>
              <input type="text" name="title" class="form-control" value="{{ property.title }}" required>
            </div>
            <div class="form-group">
              <label for="type">Type</label>
              <select id="type" name="type" class="form-control" required>
                <option value="">SELECT</option>
                <option value="TANAH" {% if property.type == 'TANAH' %}selected{% endif %}>TANAH</option>
                <option value="RUMAH" {% if property.type == 'RUMAH' %}selected{% endif %}>RUMAH</option>
                <option value="RUKO" {% if property.type == 'RUKO' %}selected{% endif %}>RUKO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="price">Price</label>
              <input type="number" name="price" class="form-control" id="price" value="{{ property.price }}" required>
            </div>
            <div class="form-group">
              <label for="description">Description</label>
              <textarea name="description" class="form-control" rows="5" required>{{ property.description }}</textarea>
            </div>
            <div class="form-group">
              <label for="location">Location</label>
              <input type="text" name="location" class="form-control" value="{{ property.location }}" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Current Images</label>
              <div class="card">
                {% for image in images %}
                  <img src="data:image/jpeg;base64,{{ image.image_data }}" alt="Current Image"
                    style="width: 100%; object-fit: cover;">
                {% endfor %}
              </div>
            </div>
            <div class="form-group">
              <label>New Images</label>
              <div class="custom-file">
                <input type="file" name="new_images[]" class="custom-file-input" id="newImageInput" multiple>
                <label class="custom-file-label" for="newImageInput">Choose files</label>
              </div>
              <div class="mt-3">
                <div id="newImagesContainer">
                  <div id="imageIndicators" class="mb-3">No images uploaded.</div>
                  <div id="imagePagination" class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-secondary" id="prevImage" disabled>Previous</button>
                    <span id="currentImageIndicator">0 / 0</span>
                    <button type="button" class="btn btn-secondary" id="nextImage" disabled>Next</button>
                  </div>
                  <div class="mt-3 card">
                    <img id="preview" src="#" alt="New Image Preview"
                      style="width: 100%; height: auto; display: none; object-fit: cover;">
                  </div>
                </div>
                <div class="form-group mt-3 text-center">
                  <button type="button" class="btn btn-secondary" id="addMoreImages">Add More Images</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group text-center mt-4">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function validateForm() {
    var price = document.getElementById("price").value;
    if (isNaN(price) || price <= 0) {
      alert("Price must be a positive number");
      return false;
    }
    return true;
  }

  let newImages = [];
  let currentIndex = 0;

  document.getElementById('newImageInput').addEventListener('change', function (e) {
    handleFileSelect(e.target.files);
  });

  document.getElementById('addMoreImages').addEventListener('click', function () {
    var newFileInput = document.createElement('input');
    newFileInput.type = 'file';
    newFileInput.name = 'new_images[]';
    newFileInput.className = 'custom-file-input';
    newFileInput.multiple = true;
    newFileInput.style.display = 'none';
    document.body.appendChild(newFileInput);

    newFileInput.addEventListener('change', function (e) {
      handleFileSelect(e.target.files);
      document.body.removeChild(newFileInput);
    });

    newFileInput.click();
  });

  function handleFileSelect(files) {
    if (files.length > 0) {
      for (var i = 0; i < files.length; i++) {
        var reader = new FileReader();
        reader.onload = function (e) {
          newImages.push(e.target.result);
          updateImageIndicators();
          if (newImages.length === 1) {
            displayImage(0);
          }
        };
        reader.readAsDataURL(files[i]);
      }
    }
  }

  function updateImageIndicators() {
    const imageIndicators = document.getElementById('imageIndicators');
    if (newImages.length === 0) {
      imageIndicators.textContent = 'No images uploaded.';
    } else {
      imageIndicators.textContent = `Uploaded ${newImages.length} image${newImages.length > 1 ? 's' : ''}.`;
    }
    document.getElementById('currentImageIndicator').textContent = `${currentIndex + 1} / ${newImages.length}`;
    document.getElementById('prevImage').disabled = currentIndex === 0;
    document.getElementById('nextImage').disabled = currentIndex === newImages.length - 1;
  }

  document.getElementById('prevImage').addEventListener('click', function () {
    if (currentIndex > 0) {
      displayImage(currentIndex - 1);
    }
  });

  document.getElementById('nextImage').addEventListener('click', function () {
    if (currentIndex < newImages.length - 1) {
      displayImage(currentIndex + 1);
    }
  });

  function displayImage(index) {
    currentIndex = index;
    const preview = document.getElementById('preview');
    preview.src = newImages[index];
    preview.style.display = 'block';
    updateImageIndicators();
  }
</script>
{% endblock %}
